# CI/CD Pipeline Documentation

## Overview

The World Anvil MCP Server uses GitHub Actions for continuous integration and continuous delivery. The pipeline enforces strict quality gates and ensures all code meets production standards before merging to main.

**File Location**: `.github/workflows/ci.yml`

---

## Pipeline Triggers

The CI pipeline runs on two events:

1. **Push to main branch** - Validates every commit to production branch
2. **Pull request to main branch** - Validates all incoming code before merge

```yaml
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
```

---

## Jobs Overview

### Test & Quality Gates Job

**Runs on**: ubuntu-latest (GitHub-hosted runner)
**Timeout**: 30 minutes (safety limit)
**Python Version**: 3.11 (project requirement)

#### Step-by-Step Execution

```
1. Checkout Code
   ↓
2. Setup Python 3.11 + Cache
   ↓
3. Install uv Package Manager
   ↓
4. Install Dependencies (dev + test extras)
   ↓
5. Format Check (ruff format --check)
   ↓
6. Lint Check (ruff check)
   ↓
7. Type Check (mypy src/world_anvil_mcp)
   ↓
8. Run Tests with Coverage
   ↓
9. Upload Test Results
   ↓
10. Upload Coverage to Codecov
    ↓
11. Comment PR with Coverage Summary
```

---

## Quality Gates Detail

### 1. Format Check
```yaml
- name: Format check
  run: ruff format --check .
```

**Purpose**: Ensures code matches project style (line length 100, double quotes, etc.)
**Configured in**: `pyproject.toml` [tool.ruff.format]
**Failure**: Returns exit code 1 if formatting issues found
**Auto-fix**: Run `ruff format .` locally to fix

### 2. Lint Check
```yaml
- name: Lint check
  run: ruff check .
```

**Purpose**: Enforces code quality rules (naming, complexity, security, etc.)
**Rules Enabled**: 25+ categories (E, W, F, I, N, UP, ANN, S, B, etc.)
**Configured in**: `pyproject.toml` [tool.ruff.lint]
**Test Exceptions**: Tests have relaxed rules (S101: assert allowed, etc.)
**Failure**: Returns exit code 1 if violations found
**Auto-fix**: Run `ruff check --fix .` locally to auto-fix

### 3. Type Check
```yaml
- name: Type check (mypy strict)
  run: mypy src/world_anvil_mcp
```

**Purpose**: Enforces strict type safety (no implicit Any, all defs typed, etc.)
**Mode**: STRICT (mypy --strict equivalent)
**Configured in**: `pyproject.toml` [tool.mypy]
**Test Override**: Tests use `disallow_untyped_defs = false` (fixtures are flexible)
**Failure**: Returns exit code 1 if type issues found
**Configuration Details**:
- Python version: 3.11
- All function parameters and returns must have type hints
- No implicit Optional types
- Strict equality checks enabled
- No unused type: ignore comments

### 4. Test Execution
```yaml
- name: Run tests with coverage
  run: |
    pytest \
      --cov=src/world_anvil_mcp \
      --cov-report=xml \
      --cov-report=term-missing \
      --cov-fail-under=85 \
      --junit-xml=test-results.xml \
      -v
```

**Purpose**: Run all tests and measure code coverage
**Configured in**: `pyproject.toml` [tool.pytest.ini_options]
**Test Markers**:
- `@pytest.mark.unit` - Fast tests, no I/O (runs automatically)
- `@pytest.mark.integration` - Mocked HTTP (runs automatically)
- `@pytest.mark.e2e` - Live API (skipped in CI, requires --e2e flag)

**Coverage Requirements**:
- Minimum: 85% (enforced with `--cov-fail-under=85`)
- Excluded from coverage:
  - Test files (`*/tests/*`)
  - `__init__.py` files
  - `conftest.py`
  - `# pragma: no cover` lines
  - Abstract methods
  - Type checking blocks

**Pytest Configuration**:
- Asyncio mode: auto (supports async test functions)
- Test discovery: `tests/test_*.py`
- Timeout: 30 seconds per test
- Markers: unit, integration, e2e, slow (strict mode enforced)
- Output: Short tracebacks, show local variables

**Failure Conditions**:
1. Test assertion fails
2. Code coverage falls below 85%
3. Test execution timeout (30s per test)

---

## Artifact & Report Management

### 5. Upload Test Results
```yaml
- name: Upload test results
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: test-results
    path: test-results.xml
```

**Purpose**: Preserve JUnit XML test results for analysis
**Format**: JUnit XML (compatible with CI platforms)
**Retention**: 90 days (GitHub default)
**When**: Always (even if tests fail)
**Access**: Available in GitHub Actions "Artifacts" tab

### 6. Upload Coverage to Codecov
```yaml
- name: Upload coverage to Codecov
  uses: codecov/codecov-action@v4
  with:
    file: ./coverage.xml
    flags: unittests
    name: codecov-umbrella
    fail_ci_if_error: true
    token: ${{ secrets.CODECOV_TOKEN }}
```

**Purpose**: Track coverage trends over time with Codecov
**Required Setup**: Add `CODECOV_TOKEN` secret to repository settings
**Coverage Report**: Generated by pytest-cov as `coverage.xml`
**Fail Behavior**: Pipeline fails if Codecov upload fails (prevents CI masking real coverage)
**Dashboard**: View at codecov.io (link in repository)

### 7. Comment PR with Coverage
```yaml
- name: Comment PR with coverage
  if: github.event_name == 'pull_request'
  uses: py-cov-action/python-coverage-comment-action@v3
  with:
    GITHUB_TOKEN: ${{ github.token }}
    MINIMUM_GREEN: 85
    MINIMUM_ORANGE: 70
```

**Purpose**: Post coverage summary as comment on pull request
**Triggers**: Pull request events only (not on push)
**Coverage Display**:
- Green badge: ≥85% (target)
- Orange warning: 70-85% (caution)
- Red alert: <70% (unacceptable)

**Comment Content**:
- Overall coverage percentage
- Coverage by file
- Changes in coverage (vs base branch)
- Missing lines summary

---

## Permissions

```yaml
permissions:
  contents: read
  checks: write
  pull-requests: write
```

**Least Privilege Principle**:
- `contents: read` - Can read repository code
- `checks: write` - Can write check results
- `pull-requests: write` - Can comment on PRs

---

## Local Development Workflow

### Before Pushing

Run quality gates locally to avoid CI failures:

```bash
# Format code
ruff format .

# Check linting
ruff check . --fix

# Type check
mypy src/world_anvil_mcp

# Run tests with coverage
pytest --cov=src/world_anvil_mcp --cov-fail-under=85
```

### Or Use Combined Command

```bash
# All quality checks in one command
make check  # If Makefile available

# Or manually
ruff format . && ruff check . && mypy src/world_anvil_mcp && pytest --cov=src/world_anvil_mcp --cov-fail-under=85
```

### Pre-commit Hook (Optional)

Configure pre-commit to run checks before committing:

```bash
# Install pre-commit hooks
pre-commit install

# Hooks configured in .pre-commit-config.yaml
# Auto-runs on: git commit
```

---

## Pipeline Failure Troubleshooting

### Format Check Fails
```
ERROR: formatting checks failed
```
**Solution**: Run `ruff format .` and commit changes

### Lint Check Fails
```
ERROR: 1 error found in example.py
```
**Solution**: Review error, run `ruff check --fix .` or fix manually

### Type Check Fails
```
error: Name "x" is not defined [name-defined]
```
**Solution**: Add type hints or fix missing imports
**Reference**: See mypy error codes at mypy.readthedocs.io

### Test Fails
```
FAILED tests/test_client.py::test_example - AssertionError
```
**Solution**: Fix test or implementation. Run locally first: `pytest -v`

### Coverage Below 85%
```
FAILED: Coverage 82% < minimum 85%
```
**Solution**: Add tests to increase coverage, check `--cov-report=term-missing`

### Codecov Upload Fails
```
ERROR: Codecov upload failed
```
**Solution**: Check CODECOV_TOKEN secret is set in repository settings

---

## Environment Variables & Secrets

### Required Secrets

Add to GitHub repository settings (Settings → Secrets and variables → Actions):

```
CODECOV_TOKEN
  Description: Codecov API token for coverage uploads
  Value: From codecov.io repository settings
```

### Optional Secrets

None currently required. Coverage upload fails gracefully if token missing.

---

## Performance & Optimization

### Dependency Caching
```yaml
cache: 'pip'
```
Caches pip dependencies between runs, reducing install time by ~60%

### Parallel Testing
Tests run serially by default (pytest). For large test suites:
```bash
pytest -n auto  # Requires pytest-xdist
```

### Expected Runtime
- Format check: ~5 seconds
- Lint check: ~10 seconds
- Type check: ~15 seconds
- Test execution: ~30 seconds (depends on test suite size)
- **Total**: ~1-2 minutes (with caching)

---

## CI/CD Status Monitoring

### GitHub Status Checks

Each job appears as a status check on pull requests:
- Green checkmark (✓) = Job passed
- Red X (✗) = Job failed
- Yellow dot (◯) = Job in progress

### Workflow Runs Dashboard
Access at: Repository → Actions → CI workflow

**Status Information**:
- Run time and duration
- Which step failed (if any)
- Log output for debugging
- Workflow file version

### Branch Protection

To enforce CI before merging:
1. Settings → Branches → Add rule
2. Branch name: `main`
3. Require status checks to pass: Enable "CI / test"
4. Dismiss stale reviews: Optional
5. Save

---

## Integration with Development Process

### Pull Request Flow
```
1. Create feature branch
2. Commit changes locally (run make check first)
3. Push to GitHub
4. Create pull request
5. CI runs automatically
   ├─ Format check
   ├─ Lint check
   ├─ Type check
   ├─ Test execution
   └─ Coverage reporting
6. Review coverage comment
7. Merge (only if all checks pass + code review approved)
```

### Release Flow (Post-Phase 1.1)
```
1. Merge features to main
2. CI confirms quality (all checks pass)
3. Create release tag: git tag v0.1.0
4. Push tag
5. Deployment pipeline triggered (future phase)
```

---

## Troubleshooting Guide

| Problem | Solution |
|---------|----------|
| "Permission denied" on file operations | Check GitHub token permissions (contents: read) |
| "ModuleNotFoundError" in tests | Ensure all imports are in requirements or dev extras |
| "Timeout" during tests | Increase timeout-minutes or optimize slow tests |
| "Out of disk space" | Unlikely on GitHub runners, check artifact cleanup |
| CI passes locally but fails on GitHub | Check Python version 3.11, environment variables |
| Codecov token invalid | Regenerate at codecov.io/repositories |

---

## References

- **GitHub Actions Docs**: https://docs.github.com/en/actions
- **Ruff Docs**: https://docs.astral.sh/ruff/
- **Mypy Docs**: https://mypy.readthedocs.io/
- **Pytest Docs**: https://docs.pytest.org/
- **Codecov Docs**: https://docs.codecov.io/

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2025-11-29 | Initial CI/CD pipeline for Phase 1.1 |

---

**Last Updated**: 2025-11-29
**Maintained By**: Backend Architecture Team
**Status**: Production Ready
